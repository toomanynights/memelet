<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Memelet</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='clippy/build/clippy.css') }}" media="all">
    <style>
        .btn {
            padding: 15px 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-button">‚Üê Back to Collection</a>
        
        <h1>‚öôÔ∏è Settings</h1>
        
        <div class="section">
            <h2>Manual Actions</h2>
            
            <div id="message-container"></div>
            
            <p class="action-description">
                Trigger manual scans and processing. The automated scan runs every hour.
            </p>
            
            <button type="button" class="btn btn-primary" id="scan-btn" onclick="triggerAction('scan')">
                üîç Scan & Process New Memes
            </button>
            
            <button type="button" class="btn btn-warning" id="retry-btn" onclick="triggerAction('retry_errors')">
                üîÑ Reprocess Errors
            </button>

            <button type="button" class="btn" id="scan-tags-btn" onclick="triggerAction('scan_tags_all')">
                üîé Scan Tags (All Memes)
            </button>
        </div>
        
        <div class="section">
            <h2>Latest Scan Activity</h2>
            <p class="action-description">
                Most recent scan log entry (auto-refreshes every 10 seconds)
            </p>
            <div class="log-container" id="log-content">{{ log_content }}</div>
        </div>
        
        <div class="section">
            <h2>Clippy Agent Appearance</h2>
            <p class="action-description">
                Select which assistant agent to display, or choose "None" to disable Clippy
            </p>
            <div class="agent-selector" id="agentSelector">
                <!-- Agent previews will be generated here -->
            </div>
            <div id="agent-message" style="margin-top: 15px;"></div>
        </div>
    </div>
    
    <script>
        let isProcessing = false;
        let logCheckInterval;
        
        function triggerAction(action) {
            // Disable buttons
            isProcessing = true;
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('retry-btn').disabled = true;
            const scanTagsBtn = document.getElementById('scan-tags-btn');
            if (scanTagsBtn) scanTagsBtn.disabled = true;
            
            if (action === 'scan') {
                document.getElementById('scan-btn').textContent = '‚è≥ Processing...';
            } else if (action === 'retry_errors') {
                document.getElementById('retry-btn').textContent = '‚è≥ Processing...';
            } else if (action === 'scan_tags_all') {
                if (scanTagsBtn) scanTagsBtn.textContent = '‚è≥ Processing...';
            }
            
            // Show message
            showMessage('Starting process... Check the log below for progress.', 'success');
            
            // Trigger action via AJAX
            fetch('/api/trigger-action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: action })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    // Start checking log for completion
                    logCheckInterval = setInterval(checkIfProcessingComplete, 2000);
                } else {
                    showMessage(data.message, 'error');
                    enableButtons();
                }
            })
            .catch(error => {
                showMessage('Error triggering action: ' + error, 'error');
                enableButtons();
            });
        }
        
        function showMessage(text, type) {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="message ${type}">${text}</div>`;
        }
        
        function enableButtons() {
            isProcessing = false;
            document.getElementById('scan-btn').disabled = false;
            document.getElementById('retry-btn').disabled = false;
            document.getElementById('scan-btn').textContent = 'üîç Scan & Process New Memes';
            document.getElementById('retry-btn').textContent = 'üîÑ Reprocess Errors';
            const scanTagsBtn = document.getElementById('scan-tags-btn');
            if (scanTagsBtn) {
                scanTagsBtn.disabled = false;
                scanTagsBtn.textContent = 'üîé Scan Tags (All Memes)';
            }
            
            if (logCheckInterval) {
                clearInterval(logCheckInterval);
            }
        }
        
        let lastLogContent = '';
        
        function checkIfProcessingComplete() {
            fetch('/settings')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newLogContent = doc.getElementById('log-content').textContent;
                    
                    // Check if log content changed and contains completion message
                    if (newLogContent !== lastLogContent && 
                        newLogContent.includes('completed')) {
                        showMessage('‚úì Process completed!', 'success');
                        enableButtons();
                    }
                    
                    lastLogContent = newLogContent;
                    document.getElementById('log-content').textContent = newLogContent;
                })
                .catch(error => console.error('Error checking log:', error));
        }
        
        // Auto-refresh log every 5 seconds
        setInterval(function() {
            if (!isProcessing) {
                fetch('/settings')
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newLogContent = doc.getElementById('log-content').textContent;
                        document.getElementById('log-content').textContent = newLogContent;
                    })
                    .catch(error => console.error('Error refreshing log:', error));
            }
        }, 5000);
    </script>
    
    <!-- Agent Selector Script -->
    <script>
        let currentAgent = '{{ current_agent }}';
        
        function createAgentPreview(agent, isNone = false) {
            const preview = document.createElement('div');
            preview.className = 'agent-preview';
            preview.dataset.agent = agent ? agent.name : 'none';
            
            if (isNone) {
                preview.innerHTML = `
                    <div class="agent-preview-none">
                        <div class="agent-preview-icon">üö´</div>
                    </div>
                    <div class="agent-name">None</div>
                `;
            } else {
                // Create image container (80x80px)
                const container = document.createElement('div');
                container.className = 'agent-preview-image-container';
                
                const img = document.createElement('img');
                img.alt = agent.name;
                
                // Scale preview image to fit 80px height while maintaining aspect ratio
                img.onload = function() {
                    try {
                        const naturalWidth = img.naturalWidth;
                        const naturalHeight = img.naturalHeight;
                        
                        if (naturalHeight > 0) {
                            // Calculate scale to fit 80px height
                            const scale = 80 / naturalHeight;
                            const scaledWidth = naturalWidth * scale;
                            
                            // Set image size
                            img.style.width = `${scaledWidth}px`;
                            img.style.height = `${80}px`;
                        }
                    } catch (e) {
                        console.error('Error scaling preview image:', e);
                    }
                };
                
                img.onerror = function() {
                    console.error(`Failed to load preview.png for agent: ${agent.name}`);
                    // Show placeholder or agent name as fallback
                    img.style.display = 'none';
                    const placeholder = document.createElement('div');
                    placeholder.style.width = '80px';
                    placeholder.style.height = '80px';
                    placeholder.style.display = 'flex';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.justifyContent = 'center';
                    placeholder.style.background = '#f0f0f0';
                    placeholder.style.color = '#666';
                    placeholder.style.fontSize = '0.8rem';
                    placeholder.textContent = agent.name.substring(0, 4);
                    container.appendChild(placeholder);
                };
                
                img.src = `/static/clippy/agents/${agent.name}/preview.png`;
                container.appendChild(img);
                
                const name = document.createElement('div');
                name.className = 'agent-name';
                name.textContent = agent.name;
                
                preview.appendChild(container);
                preview.appendChild(name);
            }
            
            // Mark as selected if it matches current agent
            if ((isNone && currentAgent === 'none') || (!isNone && agent.name === currentAgent)) {
                preview.classList.add('selected');
            }
            
            preview.addEventListener('click', () => selectAgent(isNone ? 'none' : agent.name));
            
            return preview;
        }
        
        let currentClippyAgent = null;
        
        function selectAgent(agentName) {
            fetch('/api/settings/clippy-agent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ agent_form: agentName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentAgent = agentName;
                    
                    // Update UI
                    document.querySelectorAll('.agent-preview').forEach(p => {
                        p.classList.remove('selected');
                    });
                    const selected = document.querySelector(`.agent-preview[data-agent="${agentName}"]`);
                    if (selected) selected.classList.add('selected');
                    
                    // Immediately load the selected agent
                    if (agentName === 'none') {
                        // Hide current agent if any
                        if (currentClippyAgent) {
                            try {
                                currentClippyAgent.hide(false, function() {
                                        currentClippyAgent._el.remove();
                                        currentClippyAgent._balloon._balloon.remove();
                                        currentClippyAgent = null;
                                    
                                });
                            } catch (e) {
                                currentClippyAgent = null;
                            }
                        }
                    } else {
                        // Load new agent
                        if (typeof clippy !== 'undefined') {
                            // Hide current agent if any, then load new one
                            if (currentClippyAgent) {
                                try {
                                    var oldAgent = currentClippyAgent;
                                    currentClippyAgent = null;
                                    
                                    // Wait for hide animation to complete before cleaning up
                                    oldAgent.hide(false, function() {
                                        // After hide completes, remove old agent's DOM elements
                                        oldAgent._el.remove();
                                        oldAgent._balloon._balloon.remove();
                                        
                                        // NOW load the new agent
                                        clippy.load(agentName, function(agent) {
                                            currentClippyAgent = agent;
                                            window.currentClippyAgent = agent;
                                            if (window.hookClippySpeech) {
                                                window.hookClippySpeech(agent);
                                            }
                                            
                                            // Position the agent manually before showing
                                            var margin = 16;
                                            var w = $(window).width();
                                            var h = $(window).height();
                                            var elW = agent._el.outerWidth() || 124;
                                            var elH = agent._el.outerHeight() || 93;
                                            var leftPos = Math.max(margin, w - elW - margin);
                                            var topPos = Math.max(margin, h - elH - margin);
                                            agent._el.css({ top: topPos, left: leftPos });
                                            
                                            // Use the built-in show() which handles Show animation properly
                                            agent.show();
                                            
                                            // Use setTimeout to ensure DOM has updated before positioning balloon
                                            setTimeout(function() {
                                                // Get transformation phrase for the new agent
                                                window.loadClippyPhrases().then(function(phrases) {
                                                    var agentPhrase = phrases.transformation && phrases.transformation[agentName.toLowerCase()] 
                                                        ? phrases.transformation[agentName.toLowerCase()] 
                                                        : 'Hello!';
                                                    agent.speak(agentPhrase);
                                                    
                                                    try {
                                                        if (agent.hasAnimation && agent.hasAnimation('CheckingSomething')) {
                                                            agent.play('CheckingSomething', 5000);
                                                        }
                                                    } catch (e) {}
                                                }).catch(function() {
                                                    agent.speak('Hello!');
                                                    
                                                    try {
                                                        if (agent.hasAnimation && agent.hasAnimation('CheckingSomething')) {
                                                            agent.play('CheckingSomething', 5000);
                                                        }
                                                    } catch (e) {}
                                                });
                                            }, 50);
                                        });
                                    });
                                } catch (e) {
                                    // If hide fails, still clean up and load new agent
                                    if (currentClippyAgent) {
                                        currentClippyAgent._el.remove();
                                        currentClippyAgent._balloon._balloon.remove();
                                        currentClippyAgent = null;
                                    }
                                    
                                    clippy.load(agentName, function(agent) {
                                        currentClippyAgent = agent;
                                        window.currentClippyAgent = agent;
                                        if (window.hookClippySpeech) {
                                            window.hookClippySpeech(agent);
                                        }
                                        
                                        // Position the agent manually before showing
                                        var margin = 16;
                                        var w = $(window).width();
                                        var h = $(window).height();
                                        var elW = agent._el.outerWidth() || 124;
                                        var elH = agent._el.outerHeight() || 93;
                                        var leftPos = Math.max(margin, w - elW - margin);
                                        var topPos = Math.max(margin, h - elH - margin);
                                        agent._el.css({ top: topPos, left: leftPos });
                                        
                                        // Use the built-in show() which handles Show animation properly
                                        agent.show();
                                        
                                        // Use setTimeout to ensure DOM has updated before positioning balloon
                                        setTimeout(function() {
                                            // Get transformation phrase for the new agent
                                            window.loadClippyPhrases().then(function(phrases) {
                                                var agentPhrase = phrases.transformation && phrases.transformation[agentName.toLowerCase()] 
                                                    ? phrases.transformation[agentName.toLowerCase()] 
                                                    : 'Hello!';
                                                agent.speak(agentPhrase);
                                                
                                                try {
                                                    if (agent.hasAnimation && agent.hasAnimation('CheckingSomething')) {
                                                        agent.play('CheckingSomething', 5000);
                                                    }
                                                } catch (e) {}
                                            }).catch(function() {
                                                agent.speak('Hello!');
                                                
                                                try {
                                                    if (agent.hasAnimation && agent.hasAnimation('CheckingSomething')) {
                                                        agent.play('CheckingSomething', 5000);
                                                    }
                                                } catch (e) {}
                                            });
                                        }, 50);
                                    });
                                }
                            } else {
                                // No current agent, load immediately
                                clippy.load(agentName, function(agent) {
                                    currentClippyAgent = agent;
                                    window.currentClippyAgent = agent;
                                    if (window.hookClippySpeech) {
                                        window.hookClippySpeech(agent);
                                    }
                                    
                                    // Position the agent BEFORE showing it
                                    agent._hidden = false;
                                    var margin = 16;
                                    var w = $(window).width();
                                    var h = $(window).height();
                                    var elW = agent._el.outerWidth() || 124;
                                    var elH = agent._el.outerHeight() || 93;
                                    var leftPos = Math.max(margin, w - elW - margin);
                                    var topPos = Math.max(margin, h - elH - margin);
                                    agent._el.css({ top: topPos, left: leftPos });
                                    agent._el.show();
                                    agent.resume();
                                    agent._onQueueEmpty();
                                    
                                    try {
                                        if (agent.hasAnimation && agent.hasAnimation('CheckingSomething')) {
                                            agent.play('CheckingSomething', 5000);
                                        }
                                    } catch (e) {}
                                });
                            }
                        }
                    }
                    
                    // Show feedback
                    const msgEl = document.getElementById('agent-message');
                    msgEl.innerHTML = `<div class="message success">Agent selection saved${agentName === 'none' ? ' (Clippy disabled)' : ''}!</div>`;
                    setTimeout(() => msgEl.innerHTML = '', 3000);
                } else {
                    alert('Error saving selection: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error saving selection: ' + error);
            });
        }
        
        // Load agents and render selector
        fetch('/api/clippy-agents')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Agents API response:', data);
                if (data.success) {
                    const container = document.getElementById('agentSelector');
                    if (!container) {
                        console.error('Agent selector container not found!');
                        return;
                    }
                    
                    // Add "None" option first
                    container.appendChild(createAgentPreview(null, true));
                    
                    // Add all agents
                    if (data.agents && Array.isArray(data.agents)) {
                        console.log(`Loading ${data.agents.length} agents`);
                        data.agents.forEach(agent => {
                            if (agent && agent.name) {
                                container.appendChild(createAgentPreview(agent));
                            } else {
                                console.warn('Invalid agent data:', agent);
                            }
                        });
                    } else {
                        console.warn('No agents array in response:', data);
                    }
                } else {
                    console.error('Error loading agents:', data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error loading agents:', error);
                const container = document.getElementById('agentSelector');
                if (container) {
                    container.innerHTML = '<div style="color: red; padding: 10px;">Error loading agents. Please refresh the page.</div>';
                }
            });
    </script>
    <script src="{{ url_for('static', filename='jquery/jquery-3.7.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='clippy/build/clippy.js') }}"></script>
    <script src="{{ url_for('static', filename='js/clippy-phrases.js') }}"></script>
    <script src="{{ url_for('static', filename='js/clippy-session.js') }}"></script>
    <script src="{{ url_for('static', filename='js/clippy-debug.js') }}"></script>
    <script type="text/javascript">
        // Only load Clippy if agent is not 'none'
        {% if current_agent != 'none' %}
        try {
            initClippyWithSession('{{ current_agent }}', {
                useAnimations: false, // Use instant show during active session
                onLoad: function(agent, sessionState, willRestoreAnimation, clearSavedState, willSpeakQuip) {
                    try {
                        currentClippyAgent = agent;
                        try {
                            if (agent.hasAnimation && agent.hasAnimation('CheckingSomething')) {
                                // Page-specific animation should always play - clear saved state if restoring
                                if (willRestoreAnimation && clearSavedState) {
                                    clearSavedState();
                                }
                                
                                // If a quip will be spoken, load and speak it first, then play animation
                                if (willSpeakQuip) {
                                    window.loadClippyPhrases().then(function() {
                                        var categories = window.getQuipCategoriesForPage();
                                        var quip = window.getRandomClippyPhrase(categories);
                                        agent.speak(quip);
                                        // Record that we spoke a quip
                                        localStorage.setItem('clippy_last_quip_time', Date.now().toString());
                                        localStorage.setItem('clippy_pages_since_quip', '0');
                                        // Animation will queue after the speech
                                        try {
                                            agent.play('CheckingSomething', 5000);
                                        } catch (playError) {
                                            console.warn('Could not play animation (audio permission may be required):', playError);
                                        }
                                    });
                                } else {
                                    // No quip, just play animation immediately
                                    try {
                                        agent.play('CheckingSomething', 5000);
                                    } catch (playError) {
                                        console.warn('Could not play animation (audio permission may be required):', playError);
                                    }
                                }
                            }
                        } catch (animError) {
                            console.warn('Animation error:', animError);
                        }
                    } catch (showError) {
                        console.error('Error showing agent:', showError);
                    }
                }
            });
        } catch (loadError) {
            console.error('Error loading Clippy agent:', loadError);
        }
        {% endif %}
    </script>
</body>
</html>