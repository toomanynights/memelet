<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Memelet</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
    <style>
        .btn {
            padding: 15px 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-button">‚Üê Back to Collection</a>
        
        <h1>‚öôÔ∏è Settings</h1>
        
        <div class="section">
            <h2>Manual Actions</h2>
            
            <div id="message-container"></div>
            
            <p class="action-description">
                Trigger manual scans and processing. The automated scan runs every hour.
            </p>
            
            <button type="button" class="btn btn-primary" id="scan-btn" onclick="triggerAction('scan')">
                üîç Scan & Process New Memes
            </button>
            
            <button type="button" class="btn btn-warning" id="retry-btn" onclick="triggerAction('retry_errors')">
                üîÑ Reprocess Errors
            </button>
        </div>
        
        <div class="section">
            <h2>Latest Scan Activity</h2>
            <p class="action-description">
                Most recent scan log entry (auto-refreshes every 10 seconds)
            </p>
            <div class="log-container" id="log-content">{{ log_content }}</div>
        </div>
    </div>
    
    <script>
        let isProcessing = false;
        let logCheckInterval;
        
        function triggerAction(action) {
            // Disable buttons
            isProcessing = true;
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('retry-btn').disabled = true;
            
            if (action === 'scan') {
                document.getElementById('scan-btn').textContent = '‚è≥ Processing...';
            } else {
                document.getElementById('retry-btn').textContent = '‚è≥ Processing...';
            }
            
            // Show message
            showMessage('Starting process... Check the log below for progress.', 'success');
            
            // Trigger action via AJAX
            fetch('/api/trigger-action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: action })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    // Start checking log for completion
                    logCheckInterval = setInterval(checkIfProcessingComplete, 2000);
                } else {
                    showMessage(data.message, 'error');
                    enableButtons();
                }
            })
            .catch(error => {
                showMessage('Error triggering action: ' + error, 'error');
                enableButtons();
            });
        }
        
        function showMessage(text, type) {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="message ${type}">${text}</div>`;
        }
        
        function enableButtons() {
            isProcessing = false;
            document.getElementById('scan-btn').disabled = false;
            document.getElementById('retry-btn').disabled = false;
            document.getElementById('scan-btn').textContent = 'üîç Scan & Process New Memes';
            document.getElementById('retry-btn').textContent = 'üîÑ Reprocess Errors';
            
            if (logCheckInterval) {
                clearInterval(logCheckInterval);
            }
        }
        
        let lastLogContent = '';
        
        function checkIfProcessingComplete() {
            fetch('/settings')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newLogContent = doc.getElementById('log-content').textContent;
                    
                    // Check if log content changed and contains completion message
                    if (newLogContent !== lastLogContent && 
                        newLogContent.includes('completed')) {
                        showMessage('‚úì Process completed!', 'success');
                        enableButtons();
                    }
                    
                    lastLogContent = newLogContent;
                    document.getElementById('log-content').textContent = newLogContent;
                })
                .catch(error => console.error('Error checking log:', error));
        }
        
        // Auto-refresh log every 5 seconds
        setInterval(function() {
            if (!isProcessing) {
                fetch('/settings')
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newLogContent = doc.getElementById('log-content').textContent;
                        document.getElementById('log-content').textContent = newLogContent;
                    })
                    .catch(error => console.error('Error refreshing log:', error));
            }
        }, 5000);
    </script>
</body>
</html>